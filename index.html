<!DOCTYPE html>
<html>
<head>
    <title>Shipment Data Viewer - GitHub Pages Edition</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .navigation {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .nav-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin: 20px;
            text-align: center;
        }
        
        .shipment-content {
            display: none;
        }
        
        .shipment-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .overview-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .overview-card h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .info-value {
            color: #2c3e50;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .timeline {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .timeline h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
        }
        
        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-left: 30px;
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 13px;
            top: 20px;
            width: 2px;
            height: calc(100% + 10px);
            background: #ecf0f1;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .timeline-date {
            min-width: 180px;
            font-weight: 600;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .timeline-content {
            flex: 1;
            padding-left: 20px;
        }
        
        .timeline-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .timeline-description {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .raw-data {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .raw-data h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .copy-btn:hover {
            background: #229954;
        }
        
        .copy-btn.copied {
            background: #2ecc71;
        }
        
        pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid #ecf0f1;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .search-input {
            padding: 8px 15px;
            border: 1px solid #ecf0f1;
            border-radius: 5px;
            font-size: 14px;
            width: 200px;
        }
        
        .chunk-info {
            color: #7f8c8d;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì¶ Enhanced Shipment Viewer</h1>
        <p>Comprehensive shipment tracking and analysis</p>
    </div>
    
    <div class="navigation">
        <div class="nav-buttons">
            <button class="nav-btn" id="prevBtn" onclick="navigateShipment(-1)">‚¨ÖÔ∏è Previous</button>
            <span id="shipmentCounter" style="padding: 0 20px; font-weight: 600;">Loading...</span>
            <button class="nav-btn" id="nextBtn" onclick="navigateShipment(1)">Next ‚û°Ô∏è</button>
        </div>
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search shipment ID...">
            <button class="nav-btn" onclick="searchShipment()">Search</button>
            <span class="chunk-info" id="chunkInfo"></span>
        </div>
    </div>
    
    <div class="content" id="content">
        <div class="loading" id="loadingMessage">Loading shipment data...</div>
    </div>

    <script>
        let dataIndex = null;
        let currentChunkData = {};
        let currentShipmentIndex = 0;
        let currentChunkId = -1;
        let allShipmentIds = [];

        // Load data index on startup
        async function loadDataIndex() {
            try {
                const response = await fetch('data_index.json');
                if (!response.ok) throw new Error('Failed to load data index');
                dataIndex = await response.json();
                
                // Load first chunk
                await loadChunk(0);
                
                // Update UI
                document.getElementById('loadingMessage').style.display = 'none';
                updateChunkInfo();
            } catch (error) {
                showError('Failed to load data index: ' + error.message);
            }
        }

        // Load a specific chunk
        async function loadChunk(chunkId) {
            if (chunkId === currentChunkId) return; // Already loaded
            
            try {
                const chunkInfo = dataIndex.chunks[chunkId];
                const response = await fetch(chunkInfo.filename);
                if (!response.ok) throw new Error('Failed to load chunk');
                
                currentChunkData = await response.json();
                currentChunkId = chunkId;
                
                // Update shipment IDs list for this chunk
                updateShipmentIdsList();
                
            } catch (error) {
                showError('Failed to load data chunk: ' + error.message);
            }
        }

        // Update list of shipment IDs in current chunk
        function updateShipmentIdsList() {
            allShipmentIds = Object.keys(currentChunkData);
        }

        // Get chunk ID for a given global shipment index
        function getChunkForIndex(globalIndex) {
            return Math.floor(globalIndex / dataIndex.chunks_per_file);
        }

        // Navigate between shipments
        async function navigateShipment(direction) {
            const newIndex = currentShipmentIndex + direction;
            
            if (newIndex < 0 || newIndex >= dataIndex.total_shipments) return;
            
            currentShipmentIndex = newIndex;
            
            // Check if we need to load a new chunk
            const requiredChunk = getChunkForIndex(currentShipmentIndex);
            if (requiredChunk !== currentChunkId) {
                await loadChunk(requiredChunk);
            }
            
            // Display the shipment
            const localIndex = currentShipmentIndex % dataIndex.chunks_per_file;
            const shipmentId = allShipmentIds[localIndex];
            displayShipment(shipmentId, currentChunkData[shipmentId]);
            
            updateNavigation();
            updateChunkInfo();
        }

        // Search for shipment
        async function searchShipment() {
            const searchId = document.getElementById('searchInput').value.trim();
            if (!searchId) return;
            
            // Search through all chunks
            for (let i = 0; i < dataIndex.chunks.length; i++) {
                const chunkInfo = dataIndex.chunks[i];
                
                // Load chunk if not current
                if (i !== currentChunkId) {
                    await loadChunk(i);
                }
                
                if (searchId in currentChunkData) {
                    // Found it!
                    currentShipmentIndex = chunkInfo.start_index + allShipmentIds.indexOf(searchId);
                    displayShipment(searchId, currentChunkData[searchId]);
                    updateNavigation();
                    updateChunkInfo();
                    return;
                }
            }
            
            alert('Shipment ID not found');
        }

        // Update navigation buttons
        function updateNavigation() {
            document.getElementById('prevBtn').disabled = currentShipmentIndex === 0;
            document.getElementById('nextBtn').disabled = currentShipmentIndex >= dataIndex.total_shipments - 1;
            document.getElementById('shipmentCounter').textContent = 
                `Shipment ${currentShipmentIndex + 1} of ${dataIndex.total_shipments}`;
        }

        // Update chunk info
        function updateChunkInfo() {
            document.getElementById('chunkInfo').textContent = 
                `(Chunk ${currentChunkId + 1}/${dataIndex.total_chunks})`;
        }

        // Display shipment data
        function displayShipment(shipmentId, data) {
            const content = document.getElementById('content');
            
            // Parse the data
            const logs = data.logs || [];
            const entityCount = data.unique_entity_count || 0;
            
            // Calculate stats
            const duration = calculateDuration(logs);
            const milestones = extractMilestones(logs);
            const documents = extractDocuments(logs);
            
            // Generate HTML
            const html = `
                <div class="shipment-content active">
                    <!-- Quick Stats -->
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value">${logs.length}</div>
                            <div class="stat-label">Log Entries</div>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                            <div class="stat-value">${duration}</div>
                            <div class="stat-label">Days Duration</div>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                            <div class="stat-value">${milestones.length}</div>
                            <div class="stat-label">Key Milestones</div>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);">
                            <div class="stat-value">${documents.length}</div>
                            <div class="stat-label">Documents</div>
                        </div>
                    </div>
                    
                    <!-- Overview Cards -->
                    <div class="overview-grid">
                        ${generateOverviewCards(logs, shipmentId)}
                    </div>
                    
                    <!-- Timeline -->
                    <div class="timeline">
                        <h3>üìÖ Shipment Timeline</h3>
                        ${generateTimeline(logs)}
                    </div>
                    
                    <!-- Raw Data -->
                    <div class="raw-data">
                        <h3>
                            üìä Raw JSON Data
                            <button class="copy-btn" onclick="copyToClipboard('${shipmentId}')">üìã Copy</button>
                        </h3>
                        <pre id="raw-${shipmentId}">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        // Helper functions
        function calculateDuration(logs) {
            if (logs.length < 2) return 0;
            const first = new Date(logs[0].timestamp);
            const last = new Date(logs[logs.length - 1].timestamp);
            return Math.ceil((last - first) / (1000 * 60 * 60 * 24));
        }

        function extractMilestones(logs) {
            const milestones = [];
            const importantTypes = ['Shipment', 'ShipmentBooking', 'ShipmentPort', 'Document'];
            
            logs.forEach(log => {
                if (importantTypes.some(type => log.entity_type?.includes(type))) {
                    milestones.push(log);
                }
            });
            
            return milestones;
        }

        function extractDocuments(logs) {
            return logs.filter(log => 
                log.entity_type?.toLowerCase().includes('document') ||
                log.new_value?.document_type
            );
        }

        function generateOverviewCards(logs, shipmentId) {
            // Extract key information
            const bookingInfo = logs.find(log => log.entity_type === 'ShipmentBooking')?.new_value || {};
            const shipmentInfo = logs.find(log => log.entity_type === 'Shipment')?.new_value || {};
            const portInfo = logs.find(log => log.entity_type === 'ShipmentPort')?.new_value || {};
            
            return `
                <div class="overview-card">
                    <h3>üì¶ Basic Information</h3>
                    <div class="info-row">
                        <div class="info-label">Shipment ID:</div>
                        <div class="info-value">${shipmentId}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Booking Reference:</div>
                        <div class="info-value">${bookingInfo.booking_reference || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Container Number:</div>
                        <div class="info-value">${bookingInfo.container_number || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Container Seal:</div>
                        <div class="info-value">${bookingInfo.container_seal_number || 'None'}</div>
                    </div>
                </div>
                
                <div class="overview-card">
                    <h3>üìç Route Information</h3>
                    <div class="info-row">
                        <div class="info-label">Origin Port:</div>
                        <div class="info-value">${portInfo.pol_port_name || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Destination Port:</div>
                        <div class="info-value">${portInfo.pod_port_name || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ETD:</div>
                        <div class="info-value">${formatDate(bookingInfo.etd)}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ETA:</div>
                        <div class="info-value">${formatDate(bookingInfo.eta)}</div>
                    </div>
                </div>
            `;
        }

        function generateTimeline(logs) {
            return logs.slice(0, 10).map(log => `
                <div class="timeline-item">
                    <div class="timeline-date">${formatDate(log.timestamp)}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${log.entity_type}</div>
                        <div class="timeline-description">
                            ${log.change_reason} - Entity ID: ${log.entity_id.substring(0, 8)}...
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function copyToClipboard(shipmentId) {
            const text = document.getElementById(`raw-${shipmentId}`).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                btn.textContent = '‚úÖ Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'üìã Copy';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function showError(message) {
            document.getElementById('content').innerHTML = 
                `<div class="error">‚ùå ${message}</div>`;
        }

        // Handle Enter key in search
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchShipment();
            });
            
            // Start loading data
            loadDataIndex();
        });
    </script>
</body>
</html>